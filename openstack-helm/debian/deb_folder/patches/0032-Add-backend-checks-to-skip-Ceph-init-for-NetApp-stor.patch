From 714138e7e95a5a6c5845d62a0c86c53edf259ad5 Mon Sep 17 00:00:00 2001
From: Thiago Miranda <tmarques@windriver.com>
Date: Mon, 22 Dec 2025 11:57:55 -0300
Subject: [PATCH] Add backend checks to skip Ceph init for NetApp storage

Introduce conditional logic to skip Ceph initialization when using
NetApp backends (file, cinder, or pvc).
The script now prints an informational message and only runs the Ceph
bootstrap when the backend is rbd.

Signed-off-by: Thiago Miranda <tmarques@windriver.com>
---
 glance/templates/bin/_storage-init.sh.tpl | 10 +++++++---
 glance/templates/job-storage-init.yaml    |  4 ++++
 2 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/glance/templates/bin/_storage-init.sh.tpl b/glance/templates/bin/_storage-init.sh.tpl
index f780ff9e8..0df7cee8d 100644
--- a/glance/templates/bin/_storage-init.sh.tpl
+++ b/glance/templates/bin/_storage-init.sh.tpl
@@ -30,8 +30,12 @@ if [[ "$SCHEME" == "https" && -f /etc/ssl/certs/openstack-helm.crt ]]; then
 fi
 
 set -ex
-if [ "x$STORAGE_BACKEND" == "xpvc" ]; then
-  echo "No action required."
+if [ "x$STORAGE_BACKEND" == "xfile" ] || [ "x$STORAGE_BACKEND" == "xcinder" ] || [ "x$STORAGE_BACKEND" == "xpvc" ]; then
+  if [ "x$STORAGE_BACKEND_CEPH_ENABLED" == "xtrue" ]; then
+    echo "WARN: Ceph is enabled. Skipping $STORAGE_BACKEND backend configuration."
+  else
+    echo "INFO: No action required to use $STORAGE_BACKEND backend."
+  fi
 elif [ "x$STORAGE_BACKEND" == "xswift" ]; then
   : ${OS_INTERFACE:="internal"}
   OS_TOKEN="$(openstack token issue -f value -c id)"
@@ -41,7 +45,7 @@ elif [ "x$STORAGE_BACKEND" == "xswift" ]; then
   curl --fail -i -X POST "${OS_SWIFT_SCOPED_ENDPOINT}" \
     -H "X-Auth-Token: ${OS_TOKEN}" \
     -H "X-Account-Meta-Temp-URL-Key: ${SWIFT_TMPURL_KEY}"
-elif [ "x$STORAGE_BACKEND" == "xrbd" ]; then
+elif [ "x$STORAGE_BACKEND" == "xrbd" ] && [ "x$STORAGE_BACKEND_CEPH_ENABLED" == "xtrue" ]; then
   ceph -s
   function ensure_pool () {
     if [ "$2" -eq 0 ]; then
diff --git a/glance/templates/job-storage-init.yaml b/glance/templates/job-storage-init.yaml
index 5e6a210ab..db3aabdd0 100644
--- a/glance/templates/job-storage-init.yaml
+++ b/glance/templates/job-storage-init.yaml
@@ -112,6 +112,10 @@ spec:
                   fieldPath: metadata.namespace
             - name: STORAGE_BACKEND
               value: {{ .Values.storage | quote }}
+            {{- range .Values.storage_conf.storage_backends }}
+            - name: "STORAGE_BACKEND_{{ .name | upper }}_ENABLED"
+              value: "{{ .enabled | toString }}"
+            {{- end }}
             {{- if eq .Values.storage "rbd" }}
             - name: RBD_POOL_NAME
               value: {{ .Values.conf.glance.rbd.rbd_store_pool | quote }}
-- 
2.34.1

