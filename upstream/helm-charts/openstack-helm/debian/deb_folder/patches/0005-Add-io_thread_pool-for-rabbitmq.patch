From f4c56def0797f093f626720871bd5e525227685e Mon Sep 17 00:00:00 2001
From: Bin Yang <bin.yang@intel.com>
Date: Tue, 13 Aug 2019 10:15:14 +0800
Subject: [PATCH] add io_thread_pool for rabbitmq

Signed-off-by: Bin Yang <bin.yang@intel.com>
[ Adapt openstack-helm-infra patches to Epoxy release ]
Signed-off-by: Daniel Caires <DanielMarques.Caires@windriver.com>
---
 rabbitmq/templates/statefulset.yaml | 8 ++++++++
 rabbitmq/values.yaml                | 4 ++++
 2 files changed, 12 insertions(+)

diff --git a/rabbitmq/templates/statefulset.yaml b/rabbitmq/templates/statefulset.yaml
index 771c5ff3c..827a83827 100644
--- a/rabbitmq/templates/statefulset.yaml
+++ b/rabbitmq/templates/statefulset.yaml
@@ -161,6 +161,10 @@ spec:
 {{- if .Values.conf.aux_conf }}
             - name: RABBITMQ_AUXILIARY_CONFIGURATION
               value: {{ toJson $envAll.Values.conf.aux_conf | quote }}
+{{- end }}
+{{- if $envAll.Values.io_thread_pool.enabled }}
+            - name: RABBITMQ_IO_THREAD_POOL_SIZE
+              value: {{ $envAll.Values.io_thread_pool.size | quote }}
 {{- end }}
           volumeMounts:
             - name: pod-tmp
@@ -264,6 +268,10 @@ spec:
             - name: RABBITMQ_FEATURE_FLAGS
               value: "{{ .Values.conf.feature_flags }}"
 {{- end }}
+{{- if $envAll.Values.io_thread_pool.enabled }}
+            - name: RABBITMQ_IO_THREAD_POOL_SIZE
+              value: {{ $envAll.Values.io_thread_pool.size | quote }}
+{{- end }}
 {{ dict "envAll" $envAll "component" "rabbitmq" "container" "rabbitmq" "type" "readiness" "probeTemplate" (include "rabbitmqReadinessProbeTemplate" $envAll | fromYaml) | include "helm-toolkit.snippets.kubernetes_probe" | trim | indent 10 }}
 {{ dict "envAll" $envAll "component" "rabbitmq" "container" "rabbitmq" "type" "liveness" "probeTemplate" (include "rabbitmqLivenessProbeTemplate" $envAll | fromYaml) | include "helm-toolkit.snippets.kubernetes_probe" | trim | indent 10 }}
           lifecycle:
diff --git a/rabbitmq/values.yaml b/rabbitmq/values.yaml
index bc2342fda..015d3d259 100644
--- a/rabbitmq/values.yaml
+++ b/rabbitmq/values.yaml
@@ -469,6 +469,10 @@ volume:
 # Set helm3_hook to false while using helm2
 helm3_hook: true
 
+io_thread_pool:
+  enabled: false
+  size: 64
+
 manifests:
   certificates: false
   configmap_bin: true
-- 
2.34.1
